name: PR Checks

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  # ─── PHP Syntax Check ───────────────────────────────────────────────────────
  php-syntax:
    name: PHP Syntax (${{ matrix.php }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php: ["8.0", "8.1", "8.2", "8.3"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          coverage: none

      - name: Check PHP syntax
        run: find . -name "*.php" -not -path "./vendor/*" | xargs -I {} php -l {}

  # ─── WordPress Coding Standards ─────────────────────────────────────────────
  phpcs:
    name: PHPCS (WordPress Coding Standards)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer
          coverage: none

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer packages
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Run PHPCS
        run: ./vendor/bin/phpcs --standard=WordPress --extensions=php --ignore=vendor/ .

  # ─── Plugin Check (WP.org validator) ────────────────────────────────────────
  plugin-check:
    name: Plugin Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          coverage: none

      - name: WordPress Plugin Check
        uses: wordpress/plugin-check-action@v1
        with:
          build-dir: "."
          exclude-checks: "performant_wp_query_arguments"

  # ─── Security Scan ──────────────────────────────────────────────────────────
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer
          coverage: none

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Check for known vulnerabilities in Composer dependencies
        run: composer audit --no-dev 2>/dev/null || true

      - name: Scan for hardcoded secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  # ─── Validate readme.txt ────────────────────────────────────────────────────
  readme-check:
    name: Validate readme.txt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check readme.txt exists and has required headers
        run: |
          if [ ! -f readme.txt ]; then
            echo "❌ readme.txt not found"
            exit 1
          fi
          
          # Required WP.org headers
          for header in "Plugin Name" "Stable tag" "License" "Requires at least" "Tested up to" "Requires PHP"; do
            if ! grep -q "^${header}:" readme.txt; then
              echo "❌ Missing required header: ${header}"
              exit 1
            fi
          done
          
          # Stable tag should match version in main PHP file
          STABLE=$(grep "^Stable tag:" readme.txt | sed 's/Stable tag: //' | tr -d '[:space:]')
          VERSION=$(grep "define('SHOPWALK_AI_VERSION'" shopwalk-ai.php | grep -o "'[0-9.]*'" | tr -d "'")
          
          if [ "$STABLE" != "$VERSION" ]; then
            echo "❌ Stable tag ($STABLE) does not match plugin version ($VERSION)"
            exit 1
          fi
          
          echo "✅ readme.txt is valid (stable tag: $STABLE)"
