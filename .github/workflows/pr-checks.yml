name: PR Checks

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  php-syntax:
    name: PHP Syntax
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Check PHP syntax
        run: find . -name "*.php" -not -path "./vendor/*" | xargs -I {} php -l {}

  readme-check:
    name: Validate readme.txt
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Validate readme.txt headers and version sync
        run: |
          if [ ! -f readme.txt ]; then echo "❌ readme.txt not found"; exit 1; fi

          for header in "Stable tag" "License" "Requires at least" "Tested up to" "Requires PHP"; do
            if ! grep -q "^${header}:" readme.txt; then echo "❌ Missing: ${header}"; exit 1; fi
          done

          STABLE=$(grep "^Stable tag:" readme.txt | sed 's/Stable tag: //' | tr -d '[:space:]')
          VERSION=$(grep "define('SHOPWALK_AI_VERSION'" shopwalk-ai.php | grep -o "'[0-9.]*'" | tr -d "'")
          [ "$STABLE" = "$VERSION" ] && echo "✅ Stable tag: $STABLE" || { echo "❌ $STABLE != $VERSION"; exit 1; }
